<tr>
  <% if @tbl_show_group_1_headers %>
    <th scope="row">TOTAL</th>
  <% end %>

  <% if @tbl_show_group_1_totals %>
    <% @composition.metrics.each do |metric| %>
      <%
        # Don't display an overall total for this metric if either group is not summable
        if @composition.groups[0]&.summable?(metric) && @composition.groups[1]&.summable?(metric)
          total = @composition.results.calc_sum(metric)
          text = number_with_delimiter(total)

          title = "tktk"
        else
          text = "n/a"
          title = "When grouping by #{prop_or_dim_label @composition.groups[0]&.dimension} and #{prop_or_dim_label @composition.groups[1]&.dimension}, a total for #{metric.metric} is not displayed. Adding up the #{metric.metric} value for each group does not yield a statistically meaningful number. You should avoid adding these numbers together yourself, as the result likely won't mean what you're expecting."
        end
      %>

      <td class="totals" title="<%= title %>"><%= text %></td>
    <% end %>
  <% end %>

  <% @meta&.each do |meta| %>
    <td></td>
  <% end %>

  <% @display_group_2_member_descriptors.each do |group_2_member_descriptor| %>
    <% @composition.metrics.each do |metric| %>
      <%
        # Don't display a total for this group 2 member if group 1 is not summable for this metric
        if !@composition.groups[0] || @composition.groups[0]&.summable?(metric)
          sum = @composition.results.calc_sum(metric, @composition.groups[1], group_2_member_descriptor)
          min = @composition.results.get_min(metric, @composition.groups[1], group_2_member_descriptor)
          max = @composition.results.get_max(metric, @composition.groups[1], group_2_member_descriptor)
          range = (max||0) - (min||0)
          mean = @composition.results.get_arith_mean(metric, false, group_2_member_descriptor) || 0

          total_sum = @composition.results.calc_sum(metric)
          sum_as_percent = ((sum / total_sum.to_f) * 100).round(2)

          text = number_with_delimiter(sum)

          title = [
            "Total #{metric.metric} for #{member_label(@composition, @composition.groups[1], group_2_member_descriptor)} across all #{prop_or_dim_label(@composition.groups[0].dimension).pluralize}: #{sum}",
            "#{sum_as_percent}% of overall total",
            "Mean: #{number_with_delimiter(mean)}",
            "Min: #{number_with_delimiter(min)}",
            "Max: #{number_with_delimiter(max)}",
            "Range: #{number_with_delimiter(range)}"
          ].join("\n")
        else
          title = "When grouping by #{prop_or_dim_label @composition.groups[0]&.dimension}, a total for #{metric.metric} is not displayed. Adding up the #{metric.metric} value for each group does not yield a statistically meaningful number. You should avoid adding these numbers together yourself, as the result likely won't mean what you're expecting."
          text = "n/a"
        end
      %>

      <td class="totals" title="<%= title %>"><%= text %></td>
    <% end %>
  <% end %>
</tr>
